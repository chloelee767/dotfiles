#!/usr/bin/env bash

set -eou pipefail

show_help() {
    cat << 'EOF'
Usage: k-add-host [QUERY]
  Add local hostname to /etc/hosts in remote pod (needed for mirrord).

Examples:
  k-add-host myapp    # Add hostname to myapp pod
EOF
}

while [[ $# -gt 0 ]]
do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

host="$(hostname)"

echo "Adding host: $host"

kexec --bash-cmd "echo 127.0.0.1 $host >> /etc/hosts; cat /etc/hosts"

# kubectl exec bump-7bb5c66cd4-kzwsd --container bump -- /bin/bash -c 'echo "127.0.0.1  CMBP-SG-MAR22-0323.local" >> /etc/hosts'
