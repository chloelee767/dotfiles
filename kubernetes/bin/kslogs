#!/usr/bin/env bash
set -eou pipefail

show_help() {
    cat << 'EOF'
Usage: kslogs [-c CONTEXT] [-n NAMESPACE] [-f FILTER] [QUERY]
  View logs from pod matching QUERY, piping through /bin/bash logs.

Options:
  -c, --context CONTEXT      Kubectl context (default: current)
  -n, --namespace NAMESPACE  Namespace (default: context default)
  -f, --filter FILTER        Filter command (default: grep healthcheck filter)

Examples:
  kslogs myapp              # View logs for myapp pod
  kslogs -f 'grep ERROR'    # Custom filter
EOF
}

CONTEXT=""
NAMESPACE=""
FILTER='grep -iv -E "(healthcheck|health/check)"'

while [[ $# -gt 0 ]]
do
    key="$1"
    case $key in
        -h|--help)
            show_help
            exit 0
            ;;
        -f|--filter)
            FILTER="$2"
            shift
            shift
            ;;
        -c|--context)
            CONTEXT="$2"
            shift
            shift
            ;;
        -n|--namespace)
            NAMESPACE="$2"
            shift
            shift
            ;;
        *)
            break
            ;;
    esac
done

query="$@"

if [[ -z "$CONTEXT" ]]; then
    CONTEXT="$(kubectl config current-context)"
fi

if [[ -z "$NAMESPACE" ]]; then
    NAMESPACE="$(kcurrentnamespace $CONTEXT)"
fi

echo "Context:" $CONTEXT "  Namespace:" $NAMESPACE

POD="$(kpod -c $CONTEXT -n $NAMESPACE $query)"
CONTAINER=$(kcontainer --pod $POD --context $CONTEXT --namespace $NAMESPACE)

CMD="kubectl exec -it "$POD" --container "$CONTAINER" --context "$CONTEXT" -n "$NAMESPACE" -- /bin/bash logs"
if [[ -n "$FILTER" ]]; then
    CMD="$CMD | $FILTER"
fi

set -x
bash -c "$CMD"
